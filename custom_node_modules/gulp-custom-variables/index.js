'use strict';

var path = require('path');
var gutil = require('gulp-util');
var through = require('through2');
var fs = require('fs');

module.exports = function(config) {
	var _c = config || false;

	return through.obj(function(file, enc, cb) {
		if (file.isNull()) {
			cb(null, file);
			return;
		}

		if (file.isStream()) {
			cb(new gutil.PluginError('gulp-custom-variables', 'Streaming not supported'));
			return;
		}

		if ( _c ) {
			var newFile, local, fileParts, a, tmp;

			try {
				newFile = file.clone();
				newFile.contents = Buffer.from(file.contents.toString().replace(/\{\{([^\}]+)\}\}/g, function(match, word) {
					var obj = word.trim().split('.');
					var tmp = _c[obj[0]] || word;

					obj.forEach(function(e, i) {
						if (i === 0) {
							if (typeof _c[e] !== 'undefined') {
								tmp = _c[e];
							} else {
								tmp = word;
								return false;
							}
						} else {
							if (typeof tmp[e] !== 'undefined') {
								tmp = tmp[e];
							} else {
								tmp = word;
								return false;
							}
						}
					});

					return tmp;
				}));
				this.push(newFile);
			} catch (err) {
				this.emit('error', new gutil.PluginError('gulp-custom-variables', err));
			}

			cb();
		} else {
			cb(null, file);
		}
	});
};
